---
title: "Philly Bikeshare Analysis"
author: "Daniel Fuller"
date: "September 1, 2017"
output:
      html_document:
        keep_md: true
---

```{r}
library(stringr)
library(knitr)
library(tidyverse)
library(lubridate)
library(ggplot2)
library(forecast)
library(tseries)
library(formatR)
library(CausalImpact)
library(zoo)

options(scipen = 2, digits=4)
opts_chunk$set(warning = FALSE, message = FALSE, error = FALSE, tidy = TRUE)
```

```{r}
city_data <- read.csv("https://raw.githubusercontent.com/walkabilly/Phillybikeshare/master/city_day_sum.csv")
member_data <- read.csv("https://raw.githubusercontent.com/walkabilly/Phillybikeshare/master/MemberColl.csv")
final_data <- read.csv("https://raw.githubusercontent.com/walkabilly/Phillybikeshare/master/city_day_sum.csv")
phil_temp16 <- read.csv("https://raw.githubusercontent.com/walkabilly/Phillybikeshare/master/Phil_temp_2016.csv")
```

### Convert start_time from factor to date and creating moving averages
```{r}
city_data$start_time <- ymd(city_data$start_time)
member_data$start_time <- mdy(member_data$start_time)

city_data <- city_data %>% 
  arrange(desc(start_time),
         (desc(city))
         )

city_data <- city_data %>%
  group_by(city) %>%
    mutate(
      cnt_ma7 = rollmean(by100000, k = 7, fill = by100000),
      cnt_ma30 = rollmean(by100000, k = 30, fill = by100000),
      cnt_ma = rollmean(cnt_ma7, k = 30, fill = by100000)
    )

city_data <- city_data %>%
  group_by(city) %>%
    mutate(
      cnt_ma7 = rollmean(by100000, k = 7, fill = by100000),
      cnt_ma30 = rollmean(by100000, k = 30, fill = by100000),
      cnt_ma = rollmean(cnt_ma7, k = 30, fill = by100000)
    )

member_data <- member_data %>%
  group_by(city, membertype) %>%
    mutate(
      cnt_ma7 = rollmean(by10000, k = 7, fill = by10000),
      cnt_ma30 = rollmean(by10000, k = 30, fill = by10000),
      cnt_ma = rollmean(cnt_ma7, k = 30, fill = by10000)
    )
```

### Time Series Plot 

#### All bikeshare users (members and non-members)

```{r}
cityplot <- ggplot(data = city_data, aes(x = start_time, y = by100000)) +
  geom_line() +
  stat_smooth(aes(group = dummy), method = "lm", formula = y ~ poly(x, 2), se = FALSE) +
  geom_vline(xintercept=as.numeric(city_data$start_time[1215]), linetype=4) + 
  facet_wrap(~ city) + 
  theme_classic()
  

plot(cityplot)
```

#### Data cleaning Bikeshare member type by city

#### Philadelphia

```{r}
philly_data <- filter(member_data, city == "Philly")

philly_member_plot <- ggplot(data = philly_data, aes(x = start_time, y = by10000)) +
  geom_line() +
  stat_smooth(aes(group = dummy), method = "lm", formula = y ~ poly(x, 2), se = FALSE) +
  geom_vline(xintercept=as.numeric(city_data$start_time[1215]), linetype=4) + 
  facet_wrap(~ membertype) + 
  theme_classic()
  
plot(philly_member_plot)
```

#### Boston

```{r}
boston_data <- filter(member_data, city == "Boston")

boston_member_plot <- ggplot(data = boston_data, aes(x = start_time, y = by10000)) +
  geom_line() +
  stat_smooth(aes(group = dummy), method = "lm", formula = y ~ poly(x, 2), se = FALSE) +
  geom_vline(xintercept=as.numeric(city_data$start_time[1215]), linetype=4) + 
  facet_wrap(~ membertype) + 
  theme_classic()
  
plot(boston_member_plot)
```

#### Chicago

```{r}
chicago_data <- filter(member_data, city == "Chicago")

chicago_member_plot <- ggplot(data = chicago_data, aes(x = start_time, y = by10000)) +
  geom_line() +
  stat_smooth(aes(group = dummy), method = "lm", formula = y ~ poly(x, 2), se = FALSE) +
  geom_vline(xintercept=as.numeric(city_data$start_time[1215]), linetype=4) + 
  facet_wrap(~ membertype) + 
  theme_classic()
  
plot(chicago_member_plot)
```

#### Washington

```{r}
washington_data <- filter(member_data, city == "Washington")

washington_member_plot <- ggplot(data = washington_data, aes(x = start_time, y = by10000)) +
  geom_line() +
  stat_smooth(aes(group = dummy), method = "lm", formula = y ~ poly(x, 2), se = FALSE) +
  geom_vline(xintercept=as.numeric(city_data$start_time[1215]), linetype=4) + 
  facet_wrap(~ membertype) + 
  theme_classic()
  
plot(washington_member_plot)
```

### Data analysis

#### Moving Averages

```{r}
smooth_plot <- ggplot(city_data) +
  geom_line(aes(x = start_time, y = by100000, colour = "Count")) +
  geom_line(aes(x = start_time, y = cnt_ma7, colour = "Weekly Moving Average")) +
  geom_line(aes(x = start_time, y = cnt_ma30, colour = "Monthly Moving Average")) +
  geom_vline(xintercept=as.numeric(city_data$start_time[1215]), linetype=4) + 
  facet_wrap(~ city) + 
  theme_classic() +
  ylab('Number of Trips x 100000 person') 
plot(smooth_plot)
```

#### Linear Model on Total Number of Trips With Weekly and Seasonal Moving Average

```{r}
lm_city_cnt <- lm(number_trips ~ cnt_ma*dummy*city, data = city_data)
summary(lm_city_cnt)
city_data$lm_cnt_fitted <- lm_city_cnt$fitted.values

lm_plot_cnt <- ggplot(city_data) +
  geom_line(aes(x = start_time, y = number_trips, colour = "Count")) +
  geom_line(aes(x = start_time, y = lm_cnt_fitted, colour = "Linear Model with moving averages")) +
  geom_vline(xintercept=as.numeric(city_data$start_time[1215]), linetype=4) + 
  facet_wrap(~ city) + 
  theme_classic() +
  ylab('Number of Trips') 
plot(lm_plot_cnt)
```

#### Linear Model on Trips per 100k people With Weekly and Seasonal Moving Average

```{r}
lm_city_100k <- lm(by100000 ~ cnt_ma*dummy*city, data = city_data)
summary(lm_city_100k)
city_data$lm_100k_fitted <- lm_city_100k$fitted.values

lm_plot_100k <- ggplot(city_data) +
  geom_line(aes(x = start_time, y = by100000, colour = "Count")) +
  geom_line(aes(x = start_time, y = lm_100k_fitted, colour = "Linear Model with moving averages")) +
  geom_vline(xintercept=as.numeric(city_data$start_time[1215]), linetype=4) + 
  facet_wrap(~ city) + 
  theme_classic() +
  ylab('Number of Trips x 100000 person') 
plot(lm_plot_100k)
```

## Philly CausalImpact

```{r}
##Arrange the data based on time
philly_data <- arrange(philly_data, start_time)

##Set pre- and post-periods
pre.period <- as.Date(c("2016-01-01", "2016-10-31"))
post.period <- as.Date(c("2016-11-01", "2016-12-31"))
post.period2 <- as.Date(c("2016-11-01", "2016-11-07")) ##Assess the impact one week after the strike

##Modelling all Phil data
philly_data$start_time <- as.Date(philly_data$start_time)

data <- zoo(cbind(philly_data$by100000, avgTemp_16$MEAN), as.Date(philly_data$start_time))

##Modelling without covaraites
impact_phil <- CausalImpact(data = data[,1], pre.period = pre.period, post.period = post.period, model.args = list(niter=5000, nseasons=7))
##Post-period set as one week after the strike
impact_phil2 <- CausalImpact(data = data[,1], pre.period = pre.period, post.period = post.period2, model.args = list(niter=5000, nseasons=7))
##Modelling with covaraites: temperature
impact_phil3 <- CausalImpact(data = data, pre.period = pre.period, post.period = post.period, model.args = list(niter=5000, nseasons=7))
# ##Dynamic regression: whether to include a time-varying regression coefficient. Default is FALSE
# impact_phil4 <- CausalImpact(data = data, pre.period = pre.period, post.period = post.period, model.args = list(niter=5000, nseasons=7, dynamic.regression=T))
# ##Control monthly effect
# impact_phil5 <- CausalImpact(data = data, pre.period = pre.period, post.period = post.period, model.args = list(niter=5000, nseasons=12, season.duration= 30))
# ##Control seasonal effect
# impact_phil6 <- CausalImpact(data = data, pre.period = pre.period, post.period = post.period, model.args = list(niter=5000, nseasons=4))

plot(impact_phil)
plot(impact_phil3)
# plot(impact_phil4) ##Not a good fit!!!
# plot(impact_phil5) ##Not a good fit!!!
# plot(impact_phil6) ##Not a good fit!!!


##Modelling Philadelphia data based on membership
member_bs <- read.csv("MemberColl.csv")
member_bs$start_time <- as.Date(member_bs$start_time, "%m/%d/%Y")
phil_bs_mem <- filter(member_bs, city=="Philly" & membertype == "member" & start_time > "2016-01-24")
phil_bs_nonmem <- filter(member_bs, city=="Philly" & membertype == "shortterm" & start_time > "2016-01-24")

data_mem <- zoo(cbind(phil_bs_mem$by10000), phil_bs_mem$start_time)

impact_pil_mem <- CausalImpact(data = data_mem, pre.period = pre.period, post.period = post.period, model.args = list(niter=5000, nseasons=7))
```

## Boston data analysis
```{r}
Boston_dat <- filter(final_data, city=="Boston")
Boston_dat$start_time <- as.Date(Boston_dat$start_time)

data_bos <- zoo(cbind(Boston_dat$by100000), as.Date(Boston_dat$start_time))

impact_bos <- CausalImpact(data = data_bos, pre.period = pre.period, post.period = post.period, model.args = list(niter=5000, nseasons=7))

plot(impact_bos)
```

## Chicago data anlysis 
```{r}
Chicago_dat <- filter(final_data, city=="Chicago")
Chicago_dat$start_time <- as.Date(Chicago_dat$start_time)

data_chi <- zoo(cbind(Chicago_dat$by100000), as.Date(Chicago_dat$start_time))

impact_chi <- CausalImpact(data = data_chi, pre.period = pre.period, post.period = post.period, model.args = list(niter=5000, nseasons=7))

plot(impact_chi)  ##Not a good fit to the data
```
## Washington data anlysis 
```{r}
DC_dat <- filter(final_data, city=="Washington")  ##Missing four days' data

DC_dat$start_time <- as.Date(DC_dat$start_time)
DC_dat <- arrange(DC_dat, start_time)

data_DC <- zoo(cbind(DC_dat$by100000), as.Date(DC_dat$start_time))

impact_DC <- CausalImpact(data = data_DC, pre.period = pre.period, post.period = post.period, model.args = list(niter=5000,nseasons=7))

plot(impact_DC)  ##Not a good fit to the data
```


