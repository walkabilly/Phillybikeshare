---
title: "Philly Bikeshare Analysis"
author: "Daniel Fuller"
date: "September 1, 2017"
output:
      html_document:
        keep_md: true
---

```{r}
library(stringr)
library(knitr)
library(tidyverse)
library(lubridate)
library(ggplot2)
library(forecast)
library(tseries)
library(formatR)
library(CausalImpact)
library(zoo)
library(normtest)
library(car)

options(scipen = 2, digits=4)
opts_chunk$set(warning = FALSE, message = FALSE, error = FALSE, tidy = TRUE)
```

```{r}
city_data <- read.csv("https://raw.githubusercontent.com/walkabilly/Phillybikeshare/master/city_day_sum.csv")
member_data <- read.csv("https://raw.githubusercontent.com/walkabilly/Phillybikeshare/master/MemberColl.csv")
phil_temp16 <- read.csv("https://raw.githubusercontent.com/walkabilly/Phillybikeshare/master/Phil_temp_2016.csv")
```

### Convert start_time from factor to date and creating moving averages
```{r}
city_data$start_time <- ymd(city_data$start_time)
member_data$start_time <- mdy(member_data$start_time)

city_data <- city_data %>% 
  arrange(desc(start_time),
         (desc(city))
         )

city_data <- city_data %>%
  group_by(city) %>%
    mutate(
      cnt_ma7 = rollmean(by100000, k = 7, fill = by100000),
      cnt_ma30 = rollmean(by100000, k = 30, fill = by100000),
      cnt_ma = rollmean(cnt_ma7, k = 30, fill = by100000)
      ## ADD Deseason variable
    )

member_data <- member_data %>%
  group_by(city, membertype) %>%
    mutate(
      cnt_ma7 = rollmean(by10000, k = 7, fill = by10000),
      cnt_ma30 = rollmean(by10000, k = 30, fill = by10000),
      cnt_ma = rollmean(cnt_ma7, k = 30, fill = by10000)
    )
```

### Time Series Plot 

#### All bikeshare users (members and non-members)

```{r}
cityplot <- ggplot(data = city_data, aes(x = start_time, y = by100000)) +
  geom_line() +
  stat_smooth(aes(group = dummy), method = "lm", formula = y ~ poly(x, 2), se = FALSE) +
  geom_vline(xintercept=as.numeric(city_data$start_time[""]), linetype=4) + 
  facet_wrap(~ city) + 
  theme_classic()
  

plot(cityplot)
```

#### Data cleaning Bikeshare member type by city

#### Philadelphia

```{r}
philly_mem_data <- filter(member_data, city == "Philly")

philly_member_plot <- ggplot(data = philly_mem_data, aes(x = start_time, y = by10000)) +
  geom_line() +
  stat_smooth(aes(group = dummy), method = "lm", formula = y ~ poly(x, 2), se = FALSE) +
  geom_vline(xintercept=as.numeric(city_data$start_time[1215]), linetype=4) + 
  facet_wrap(~ membertype) + 
  theme_classic()
  
plot(philly_member_plot)
```

#### Boston

```{r}
boston_mem_data <- filter(member_data, city == "Boston")

boston_member_plot <- ggplot(data = boston_mem_data, aes(x = start_time, y = by10000)) +
  geom_line() +
  stat_smooth(aes(group = dummy), method = "lm", formula = y ~ poly(x, 2), se = FALSE) +
  geom_vline(xintercept=as.numeric(city_data$start_time[1215]), linetype=4) + 
  facet_wrap(~ membertype) + 
  theme_classic()
  
plot(boston_member_plot)
```

#### Chicago

```{r}
chicago_mem_data <- filter(member_data, city == "Chicago")

chicago_member_plot <- ggplot(data = chicago_mem_data, aes(x = start_time, y = by10000)) +
  geom_line() +
  stat_smooth(aes(group = dummy), method = "lm", formula = y ~ poly(x, 2), se = FALSE) +
  geom_vline(xintercept=as.numeric(city_data$start_time[1215]), linetype=4) + 
  facet_wrap(~ membertype) + 
  theme_classic()
  
plot(chicago_member_plot)
```

#### Washington

```{r}
washington_mem_data <- filter(member_data, city == "Washington")

washington_member_plot <- ggplot(data = washington_mem_data, aes(x = start_time, y = by10000)) +
  geom_line() +
  stat_smooth(aes(group = dummy), method = "lm", formula = y ~ poly(x, 2), se = FALSE) +
  geom_vline(xintercept=as.numeric(city_data$start_time[1215]), linetype=4) + 
  facet_wrap(~ membertype) + 
  theme_classic()
  
plot(washington_member_plot)
```

### Data analysis

#### Moving Averages

```{r}
smooth_plot <- ggplot(city_data) +
  geom_line(aes(x = start_time, y = by100000, colour = "Count")) +
  geom_line(aes(x = start_time, y = cnt_ma7, colour = "Weekly Moving Average")) +
  geom_line(aes(x = start_time, y = cnt_ma30, colour = "Monthly Moving Average")) +
  geom_vline(xintercept=as.numeric(city_data$start_time[1215]), linetype=4) + 
  facet_wrap(~ city) + 
  theme_classic() +
  ylab('Number of Trips x 100000 person') 
plot(smooth_plot)
```


### Linear Model on Trips per 100K people
### Covaraites: (1) daily average temperature; (2) daily average precipitation; (3) dummy varaible: 0 - no strike, 1 - strike; (4) Trips per 100K, Boston; (5) Trips per 100K, Washington DC; (6) Trips per 100K, Chicago; (7) time; (8) Interaction between time and dummy

```{r}

trip_Philly <- arrange(dplyr::select(filter(city_data,city=="Philly"),by100000,dummy,start_time), start_time)
trip_Boston <- arrange(dplyr::select(filter(city_data,city=="Boston"),by100000,start_time),start_time)
trip_Washington <- arrange(dplyr::select(filter(city_data,city=="Washington"),by100000, start_time),start_time)
trip_Chicago <- arrange(dplyr::select(filter(city_data,city=="Chicago"),by100000,start_time),start_time)

time <- 1:366

lm_tripRate <- lm(trip_Philly$by100000 ~ phil_temp16$MEAN + phil_temp16$PRCP + trip_Philly$dummy+ trip_Boston$by100000 + trip_Washington$by100000 + trip_Chicago$by100000 + time + time*trip_Philly$dummy) 

summary(lm_tripRate)

tripPhilly_fitted <- lm_tripRate$fitted.values
lm_plot_tripRate <- ggplot(trip_Philly) +
  geom_line(aes(x = start_time, y = by100000)) +
  geom_line(aes(x = start_time, y = tripPhilly_fitted, colour = "#339999")) +
  theme_classic() +
  ylab('Trips per 100K people') 

plot(lm_plot_tripRate)


### Accounting for the potential quadratic trend of the data (time squared). This term captures the curvature of the trend
lm_tripRate2 <- lm(trip_Philly$by100000 ~ phil_temp16$MEAN + phil_temp16$PRCP + trip_Philly$dummy+ trip_Boston$by100000 + trip_Washington$by100000 + trip_Chicago$by100000 + poly(time, 2) + time*trip_Philly$dummy) ##Code for time squared interaction is I(time^2)*trip_Philly$dummy

summary(lm_tripRate2)

tripPhilly_fitted2 <- lm_tripRate2$fitted.values
lm_plot_tripRate2 <- ggplot(trip_Philly) +
  geom_line(aes(x = start_time, y = by100000)) +
  geom_line(aes(x = start_time, y = tripPhilly_fitted2, colour = "#339999")) +
  theme_classic() +
  ylab('Trips per 100K people') 

plot(lm_plot_tripRate2)

```


###Linear model on Trips per 100K people, weekly moving average
```{r}

trip_Philly_MA <- arrange(dplyr::select(filter(city_data,city=="Philly"),cnt_ma7,dummy,start_time),start_time)
trip_Boston_MA <- arrange(dplyr::select(filter(city_data,city=="Boston"),cnt_ma7,start_time),start_time)
trip_Washington_MA <- arrange(dplyr::select(filter(city_data,city=="Washington"),cnt_ma7,start_time),start_time)
trip_Chicago_MA <- arrange(dplyr::select(filter(city_data,city=="Chicago"),cnt_ma7,start_time),start_time)

time_MA <- 1:366

lm_tripRate_MA <- lm(trip_Philly_MA$cnt_ma7 ~ phil_temp16$MEAN + phil_temp16$PRCP + trip_Philly_MA$dummy+ trip_Boston_MA$cnt_ma7 + trip_Washington_MA$cnt_ma7 + trip_Chicago_MA$cnt_ma7 + time_MA + time_MA*trip_Philly_MA$dummy) 

summary(lm_tripRate_MA)

tripPhilly_fitted_MA <- lm_tripRate_MA$fitted.values
lm_plot_tripRate_MA <- ggplot(trip_Philly_MA) +
  geom_line(aes(x = start_time, y = cnt_ma7)) +
  geom_line(aes(x = start_time, y = tripPhilly_fitted_MA, colour = "#339999")) +
  theme_classic() +
  ylab('Trips per 100K people_Weekly moving average') 

plot(lm_plot_tripRate_MA)


### Accounting for the potential quadratic trend of the data (time squared). This term captures the curvature of the trend
lm_tripRate_MA2 <- lm(trip_Philly_MA$cnt_ma7 ~ phil_temp16$MEAN + phil_temp16$PRCP + trip_Philly_MA$dummy+ trip_Boston_MA$cnt_ma7 + trip_Washington_MA$cnt_ma7 + trip_Chicago_MA$cnt_ma7 + poly(time_MA,2) + time_MA*trip_Philly_MA$dummy) 

summary(lm_tripRate_MA2)

tripPhilly_fitted_MA2 <- lm_tripRate_MA2$fitted.values
lm_plot_tripRate_MA2 <- ggplot(trip_Philly_MA) +
  geom_line(aes(x = start_time, y = cnt_ma7)) +
  geom_line(aes(x = start_time, y = tripPhilly_fitted_MA2, colour = "#339999")) +
  theme_classic() +
  ylab('Trips per 100K people_Weekly moving average') 

plot(lm_plot_tripRate_MA2)
```



### Subset to create datasets for each city

```{r}
philly_data <- filter(city_data, city == "Philly")
boston_data <- filter(city_data, city == "Boston")
chicago_data <- filter(city_data, city == "Chicago")
washington_data <- filter(city_data, city == "Washington")
```

## Philly CausalImpact

```{r}
##Arrange the data based on time
philly_data <- arrange(philly_data, start_time)

##Set pre- and post-periods
pre_period <- as.Date(c("2016-01-01", "2016-10-31"))
post_period <- as.Date(c("2016-11-01", "2016-12-31"))
post_period2 <- as.Date(c("2016-11-01", "2016-11-07")) ##Assess the impact one week after the strike

##Modelling all Phil data
philly_data <- zoo(cbind(philly_data$by100000, phil_temp16$MEAN), as.Date(philly_data$start_time))

##Modelling without covaraites
impact_phil <- CausalImpact(data = philly_data, pre.period = pre_period, post.period = post_period, model.args = list(niter=5000, nseasons=7))
summary(impact_phil)

plot(impact_phil)

##Post-period set as one week after the strike
impact_phil2 <- CausalImpact(data = philly_data, pre.period = pre_period, post.period = post_period2, model.args = list(niter=5000, nseasons=7))
summary(impact_phil2)

##Modelling with covaraites: temperature
impact_phil3 <- CausalImpact(data = philly_data, pre.period = pre_period, post.period = post_period, model.args = list(niter=5000, nseasons=7))
summary(impact_phil3)

plot(impact_phil3)

# ##Dynamic regression: whether to include a time-varying regression coefficient. Default is FALSE
# impact_phil4 <- CausalImpact(data = data, pre.period = pre.period, post.period = post.period, model.args = list(niter=5000, nseasons=7, dynamic.regression=T))
# ##Control monthly effect
# impact_phil5 <- CausalImpact(data = data, pre.period = pre.period, post.period = post.period, model.args = list(niter=5000, nseasons=12, season.duration= 30))
# ##Control seasonal effect
# impact_phil6 <- CausalImpact(data = data, pre.period = pre.period, post.period = post.period, model.args = list(niter=5000, nseasons=4))

# plot(impact_phil4) ##Not a good fit!!!
# plot(impact_phil5) ##Not a good fit!!!
# plot(impact_phil6) ##Not a good fit!!!
```

##Modelling Philadelphia data based on membership
```{r}
# philly_member_data <- filter(philly_mem_data, membertype == "member")
# philly_member_data$start_time <- mdy(philly_member_data$start_time)

# philly_member_data <- arrange(philly_member_data, start_time)

# philly_data_mem <- zoo(cbind(philly_member_data$by10000, philly_member_data$start_time))

# impact_pil_mem <- CausalImpact(data = philly_data_mem, pre.period = pre_period, post.period = post_period, model.args = list(niter=5000, nseasons=7))
```

## Boston data analysis
```{r}
boston_data <- zoo(cbind(boston_data$by100000), as.Date(boston_data$start_time))

impact_bos <- CausalImpact(data = boston_data, pre.period = pre_period, post.period = post_period, model.args = list(niter=5000, nseasons=7))
summary(impact_bos)

plot(impact_bos)
```

## Chicago data anlysis 
```{r}
chicago_data <- zoo(cbind(chicago_data$by100000), as.Date(chicago_data$start_time))

impact_chi <- CausalImpact(data = chicago_data, pre.period = pre_period, post.period = post_period, model.args = list(niter=5000, nseasons=7))
summary(impact_chi)

plot(impact_chi)  ##Not a good fit to the data
```

## Washington data anlysis 
```{r}
washington_data <- zoo(cbind(washington_data$by100000), as.Date(washington_data$start_time))

impact_DC <- CausalImpact(data = washington_data, pre.period = pre_period, post.period = post_period, model.args = list(niter=5000,nseasons=7))
summary(impact_DC)

plot(impact_DC)  ##Not a good fit to the data
```


